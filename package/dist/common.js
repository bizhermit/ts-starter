"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createEnv=exports.replaceTexts=exports.replaceAppName=exports.__appName__=exports.npmPackageInit=exports.removeGit=exports.generateTemplate=exports.getTemplateBaseDirname=exports.installLibs=exports.savePackageJson=exports.getPackageJson=exports.analyzeArgsOptions=void 0;const cli_utils_1=__importDefault(require("@bizhermit/cli-utils")),child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=__importDefault(require("path")),rimraf_1=__importDefault(require("rimraf")),analyzeArgsOptions=(e,t)=>{const a=t?.appName||path_1.default.basename(e);let i="";switch(process.platform){case"win32":i="win";break;case"darwin":i="mac";break;default:i="linux"}return{appName:a.replace(/ /g,"_").replace(/:/g,"-"),platform:i}};exports.analyzeArgsOptions=analyzeArgsOptions;const initializePackageContent=(e,t)=>(t.forEach((t=>{e[t.propertyName]=e[t.propertyName]||t.initValue})),e),getPackageJson=async(e,t)=>{const a=path_1.default.join(e,"package.json"),{appName:i}=(0,exports.analyzeArgsOptions)(e,t);(0,fs_extra_1.existsSync)(a)||!0===t?.allowNotFoundNpmPackage||(cli_utils_1.default.wl("not found package.json. begin create"),await(0,fs_extra_1.writeFile)(a,"{}"));const r=await(0,fs_extra_1.readFile)(a),s=JSON.parse(r.toString());return!0!==t?.preventInit&&(initializePackageContent(s,[{propertyName:"name",initValue:i},{propertyName:"version",initValue:"0.0.0-alpha.0"},{propertyName:"description",initValue:""},{propertyName:"repository",initValue:{type:"git",url:""}},{propertyName:"bugs",initValue:{url:""}},{propertyName:"author",initValue:""},{propertyName:"contributors",initValue:[]},{propertyName:"scripts",initValue:{}},{propertyName:"dependencies",initValue:{}},{propertyName:"devDependencies",initValue:{}}]),t?.license?(initializePackageContent(s,[{propertyName:"license",initValue:"MIT"}]),await(0,fs_extra_1.copyFile)(path_1.default.join(__dirname,"../template/LICENSE"),path_1.default.join(e,"LICENSE"))):initializePackageContent(s,[{propertyName:"private",initValue:!0}])),t?.clearScripts&&(s.scripts={}),s};exports.getPackageJson=getPackageJson;const savePackageJson=async(e,t)=>{const a={},i=["name","version","description","repository","bugs","author","homepage","contributors","license","private","main","bin","files","scripts","dependencies","devDependencies","build","browser"];for(const e of i)e in t&&(a[e]=t[e]);Object.keys(t).forEach((e=>{e in a||(a[e]=t[e])})),await(0,fs_extra_1.writeFile)(path_1.default.join(e,"package.json"),JSON.stringify(a,null,2))};exports.savePackageJson=savePackageJson;const installLibs=(e,t=[],a=[],i)=>{if(t.length>0){cli_utils_1.default.wl("Installing dependencies:");for(const e of t)cli_utils_1.default.wl(` - [36m${e}[39m`);(0,child_process_1.spawnSync)("npm",["i","--legacy-peer-deps",...t],{shell:!0,stdio:"inherit",cwd:e})}if(a.length>0){cli_utils_1.default.wl("Installing devDependencies:");for(const e of a)cli_utils_1.default.wl(` - [36m${e}[39m`);(0,child_process_1.spawnSync)("npm",["i","--save-dev",...a],{shell:!0,stdio:"inherit",cwd:e})}!1!==i?.audit&&(t.length>0||a.length>0)&&(cli_utils_1.default.wl("Auditing dependencies:"),(0,child_process_1.spawnSync)("npm",["audit"],{shell:!0,stdio:"inherit",cwd:e}))};exports.installLibs=installLibs;const getTemplateBaseDirname=()=>path_1.default.join(__dirname,"../template");exports.getTemplateBaseDirname=getTemplateBaseDirname;const generateTemplate=async(e,t,a)=>{cli_utils_1.default.wl(`Create files from template: [36m${t}[39m`),await(0,fs_extra_1.copy)(path_1.default.join((0,exports.getTemplateBaseDirname)(),t),path_1.default.join(e,a?.destDir??""),{overwrite:!0,recursive:!0}),process.stdout.write("\n")};exports.generateTemplate=generateTemplate;const removeGit=e=>{rimraf_1.default.sync(path_1.default.join(e,".git"))};exports.removeGit=removeGit;const npmPackageInit=e=>{(0,child_process_1.spawnSync)("npx",["npm-package-utils","init"],{shell:!0,stdio:"inherit",cwd:e})};exports.npmPackageInit=npmPackageInit,exports.__appName__="__appName__";const replaceAppName=async(e,t)=>(0,exports.replaceTexts)(e,[{anchor:exports.__appName__,text:t}]);exports.replaceAppName=replaceAppName;const replaceTexts=async(e,t)=>{if(cli_utils_1.default.wl(`Replace texts: ${e}`),!(0,fs_extra_1.existsSync)(e))return cli_utils_1.default.wl(`[43m WARN [49m file not found: ${e}`),!1;let a=(await(0,fs_extra_1.readFile)(e)).toString();return t.forEach((e=>{const t=new RegExp(e.anchor,"g");a=a.replace(t,e.text),cli_utils_1.default.wl(` - replace: ${e.anchor} -> ${e.text}`)})),await(0,fs_extra_1.writeFile)(e,a),process.stdout.write("\n"),!0};exports.replaceTexts=replaceTexts;const createEnv=async(e,t=[])=>{await(0,fs_extra_1.writeFile)(path_1.default.join(e,".env"),t.join("\n"))};exports.createEnv=createEnv;