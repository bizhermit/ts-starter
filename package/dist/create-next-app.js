"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const string_utils_1=__importDefault(require("@bizhermit/basic-utils/dist/string-utils")),child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=__importDefault(require("path")),rimraf_1=__importDefault(require("rimraf")),common_1=require("./common"),createNextApp=async(e,t="all",n=!1,a)=>{const{appName:s,platform:r}=(0,common_1.analyzeArgsOptions)(e,a),i="__srcDir__",o="src",p="nexpress",c="nextron",_="dist",m=".next",l=".nexpress",d="__mainDistDir__",x=".main",u=".renderer",f=8e3,h=async e=>(await(0,fs_extra_1.readFile)(path_1.default.join((0,common_1.getTemplateBaseDirname)(),"next-app",e))).toString();if("web"===t&&n){const t="frontend",n="backend";await createNextApp(e,t,!1,{appName:`${s}-frontend`,targetDir:t,crossBasePath:`${s}-backend`,distFlat:!0}),await createNextApp(e,n,!1,{appName:`${s}-backend`,targetDir:n,corsOriginPort:3e3});const a=(await(0,fs_extra_1.readFile)(path_1.default.join(e,t,".gitignore"))).toString().split(/\n/g);a.splice(a.indexOf("# develop")-a.length+1),a.push(".vscode/settings.json",`/${t}/dist/`,".next",".nexpress");const r=await(0,common_1.getPackageJson)(e,{appName:s});return r.scripts={frontend:`cd ${t} && npm run dev`,backend:`cd ${n} && npm run nexpress`,dev:"npm run frontend | npm run backend","start:f":`cd ${t} && npm run next`,"start:b":`cd ${n} && npm run start`,start:"npm run start:b | npm run start:f"},await(0,common_1.savePackageJson)(e,r),await(0,fs_extra_1.writeFile)(path_1.default.join(e,".gitignore"),a.join("\n")),void(0,common_1.removeGit)(e)}const A=path_1.default.join(e,a?.targetDir??"");(0,child_process_1.spawnSync)("npx",["create-next-app",A,"--ts","--use-npm"],{shell:!0,stdio:"inherit",cwd:e});const E=path_1.default.join(A,"next.config.js"),P=(await(0,fs_extra_1.readFile)(E)).toString().split(/\n|\r\n/g),w=P.findIndex((e=>e.match(/^}(;|\s)*$/)))??1;P[w-1].match(/,$/)||(P[w-1]=P[w-1]+",");let g=[],T=[],S=[];const b=path_1.default.join(A,".gitignore");let j=(await(0,fs_extra_1.readFile)(b)).toString();j=j.replace("/.next/","/.next/"),j+="\n# develop";const v=e=>{e.forEach((e=>{j+=`\n${e}`}))};v(["/.vscode/settings.json","/dist/"]);const O=async e=>{const t=path_1.default.join(A,e);(0,fs_extra_1.existsSync)(t)&&await(0,fs_extra_1.move)(t,path_1.default.join(A,o,e),{overwrite:!0})};await O("next-env.d.ts"),await O("pages"),await O("public"),rimraf_1.default.sync(path_1.default.join(A,"styles"));const k=await(0,common_1.getPackageJson)(A,{appName:s});k.name=s,k.version="0.0.0-alpha.0";const I=["@bizhermit/basic-utils"],R=["rimraf"];let N=!1,D=!1,$=!1;const y=["node_modules","/.*"],H=["[Next.js](https://nextjs.org/)"];let B="",C="";if("desktop"!==t&&"all"!==t||(N=!0,y.push(_),await(0,common_1.generateTemplate)(A,"next-app/desktop"),await(0,common_1.replaceTexts)(path_1.default.join(A,c,"main.ts"),[{anchor:common_1.__appName__,text:s},{anchor:i,text:o},{anchor:d,text:x},{anchor:"__rendererDistDir__",text:u}]),await(0,common_1.replaceTexts)(path_1.default.join(A,c,"tsconfig.json"),[{anchor:i,text:o},{anchor:d,text:x}]),I.push("fs-extra","electron-is-dev","electron-next"),R.push("@bizhermit/minifier","@types/fs-extra","electron","electron-builder")),"frontend"===t||"desktop"===t?(await(0,common_1.generateTemplate)(A,"next-app/backend"),rimraf_1.default.sync(path_1.default.join(A,p)),N&&await(0,common_1.generateTemplate)(A,"next-app/backend-desktop")):(D=!0,await(0,common_1.generateTemplate)(A,"next-app/backend"),N&&await(0,common_1.generateTemplate)(A,"next-app/backend-desktop"),await(0,common_1.replaceTexts)(path_1.default.join(A,p,"main.ts"),[{anchor:common_1.__appName__,text:s},{anchor:i,text:o}]),await(0,common_1.replaceTexts)(path_1.default.join(A,p,"tsconfig.json"),[{anchor:"__nexpressDistDir__",text:l}]),I.push("dotenv","express","express-session","helmet","cors","csurf","cookie-parser","cookies-next"),R.push("@types/dotenv","@types/express","@types/express-session","@types/cors","@types/csurf","@types/cookie-parser")),"backend"!==t&&($=!0,await(0,common_1.generateTemplate)(A,"next-app/frontend"),N&&await(0,common_1.generateTemplate)(A,"next-app/frontend-desktop"),I.push("@bizhermit/react-addon"),a?.crossBasePath&&I.push("cookies-next")),await(0,common_1.generateTemplate)(A,"next-app/api"),"backend"===t)k.scripts={build:"npx next build"};else{y.push(_);const e=a?.distFlat?_:"dist/next";k.scripts={dev:"npx next dev -p 3000",build:"npx next build",next:"npm run build && npx next start -p 80",export:`npx rimraf ${e} && npm run build && npx next export -o ${e}`}}if($&&(C+=await h("README.next.md"),y.push(m),k.scripts={...k.scripts}),D&&(H.push("[Express](https://expressjs.com/)"),C+=await h("README.nexpress.md"),y.push(p),y.push(l),v(["/.nexpress/"]),k.scripts={...k.scripts,nexpress:"npx rimraf .next && npm run prestart && node .nexpress/main.js -d",prestart:"npx rimraf .nexpress && npx tsc -p nexpress/tsconfig.json",start:"npm run build && node .nexpress/main.js"}),N){H.push("[Electron](https://www.electronjs.org/)"),C+=await h("README.nextron.md"),y.push(c),y.push(x),y.push(u),v(["/.main/","/.renderer/","/resources/config.json"]);const e=a?.distFlat?_:"dist/pack";k.scripts={...k.scripts,"clean:nextron":"npx rimraf .main .renderer",nextron:"npx rimraf .next && npm run predist && npx electron .main/nextron/main.js",predist:`npm run clean:nextron -- ${e} && npx tsc -p nextron/tsconfig.json`,dist:"npm run build && npx next export -o .renderer && npx minifier .main && npx minifier .renderer && npx electron-builder","dist:linux":"npm run dist -- --linux & npm run clean:nextron","dist:win":"npm run dist -- --win & npm run clean:nextron","dist:mac":"npm run dist -- --mac & npm run clean:nextron",pack:`npm run dist -- --dir --${r} & npm run clean:nextron`};const t="src/public/favicon.ico";k.build={appId:`example.${s}`,productName:s,asar:!0,extends:null,extraMetadata:{main:".main/nextron/main.js"},files:["!src","!nextron","!nexpress",".main/**/*",".renderer/**/*","src/public"],extraFiles:[{from:"resources",to:"resources",filter:["**/*","!config.json"]},{from:"LICENSE",to:"LICENSE"},{from:"CREDIT",to:"CREDIT"}],directories:{output:`${e}`},win:{icon:t,target:{target:"nsis",arch:["x64"]}},mac:{icon:t,target:"dmg"},linux:{icon:t,target:["deb","rpm","snap","AppImage"],category:"Development"},nsis:{oneClick:!1,allowToChangeInstallationDirectory:!0,installerIcon:t,installerHeaderIcon:t}},k.browser={fs:!1,path:!1}}switch(g=["  basePath: process.env.BASE_PATH,","  env: {","    BASE_PATH: process.env.BASE_PATH,","    PORT: process.env.PORT,","    API_BASE_PATH: process.env.BASE_PATH,","  }"],T=["BASE_PATH=","PORT=8000","",`SESSION_NAME=${s}`,`SESSION_SECRET=${s}`,`COOKIE_PARSER_SECRET=${s}`,"",`CORS_ORIGIN=http://localhost:${a?.corsOriginPort??f}`,"CSRF_PATH=/csrf"],S=["BASE_PATH=","PORT=80","",`SESSION_NAME=${s}`,`SESSION_SECRET=${s}`,`COOKIE_PARSER_SECRET=${s}`,"","CORS_ORIGIN=https://localhost:80","CSRF_PATH=/csrf"],t){case"desktop":B="desktop application",k.scripts={clean:"npx rimraf dist .main .renderer .next node_modules",...k.scripts};break;case"backend":B="backend application server",k.scripts={clean:"npx rimraf .nexpress .next node_modules",...k.scripts};break;case"frontend":B="frontend application server",k.scripts={clean:"npx rimraf dist .nexpress .next node_modules",...k.scripts},g=["  basePath: process.env.BASE_PATH,","  env: {","    BASE_PATH: process.env.BASE_PATH,","    API_PROTOCOL: process.env.API_PROTOCOL,","    API_HOST_NAME: process.env.API_HOST_NAME,","    API_PORT: process.env.API_PORT,","    API_BASE_PATH: process.env.API_BASE_PATH,","  }"],T=["BASE_PATH=","API_PROTOCOL=http:","API_HOST_NAME=localhost","API_PORT=8000","API_BASE_PATH="],S=["BASE_PATH=","API_PROTOCOL=https:","API_HOST_NAME=localhost","API_PORT=80","API_BASE_PATH="];break;case"web":B="web application server",k.scripts={clean:"npx rimraf dist .nexpress .next node_modules",...k.scripts};break;default:B="web & desktop application",k.scripts={clean:"npx rimraf dist .nexpress .main .renderer .next node_modules",...k.scripts}}await(0,common_1.savePackageJson)(A,k),(0,common_1.installLibs)(A,I,R),await(0,common_1.replaceTexts)(path_1.default.join(A,"tsconfig.json"),[{anchor:'"node_modules"',text:[...new Set(y)].filter((e=>string_utils_1.default.isNotEmpty(e)&&!e.startsWith("."))).map((e=>`"${e}"`)).join(", ")}]),g.filter((e=>string_utils_1.default.isNotEmpty(e))).forEach(((e,t)=>{P.splice(w+t,0,e)})),await(0,fs_extra_1.writeFile)(E,P.join("\n")),await(0,fs_extra_1.writeFile)(path_1.default.join(A,".env"),T.join("\n")),await(0,fs_extra_1.writeFile)(path_1.default.join(A,"..env"),S.join("\n")),await(0,fs_extra_1.writeFile)(b,j),await(0,fs_extra_1.copy)(path_1.default.join((0,common_1.getTemplateBaseDirname)(),"next-app/README.md"),path_1.default.join(A,"README.md")),await(0,common_1.replaceTexts)(path_1.default.join(A,"README.md"),[{anchor:"__APP_TYPE__",text:B},{anchor:"__POWERED_BY__",text:H.join(", ")},{anchor:"__ADDON_README__",text:C}]),await(0,common_1.generateTemplate)(A,"dev-env/next-app/base"),await(0,common_1.replaceAppName)(path_1.default.join(A,".devcontainer/docker-compose.yml"),s),await(0,common_1.replaceAppName)(path_1.default.join(A,".devcontainer/devcontainer.json"),s),(0,common_1.removeGit)(A)};exports.default=createNextApp;