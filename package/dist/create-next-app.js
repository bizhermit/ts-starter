"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const string_utils_1=__importDefault(require("@bizhermit/basic-utils/dist/string-utils")),child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=__importDefault(require("path")),rimraf_1=__importDefault(require("rimraf")),common_1=require("./common"),createNextApp=async(e,t="all",n=!1,a)=>{const{appName:r,platform:s}=(0,common_1.analyzeArgsOptions)(e,a),o="__srcDir__",i="src",p="nexpress",c="nextron",_="dist",m=".next",d=".nexpress",l="__mainDistDir__",x=".main",u=".renderer",f=3e3,h=8e3,A=async e=>(await(0,fs_extra_1.readFile)(path_1.default.join((0,common_1.getTemplateBaseDirname)(),"next-app",e))).toString();if("web"===t&&n){const t="frontend",n="backend";await createNextApp(e,t,!1,{appName:`${r}-frontend`,targetDir:t,crossBasePath:`${r}-backend`,distFlat:!0}),await createNextApp(e,n,!1,{appName:`${r}-backend`,targetDir:n,corsOriginPort:f});const a=(await(0,fs_extra_1.readFile)(path_1.default.join(e,t,".gitignore"))).toString().split(/\n/g);a.splice(a.indexOf("# develop")-a.length+1),a.push(".vscode/settings.json",".env",`/${t}/dist/`,".next",".nexpress");const s=await(0,common_1.getPackageJson)(e,{appName:r});return s.scripts={frontend:`cd ${t} && npm run dev`,backend:`cd ${n} && npm run nexpress`,dev:"npm run frontend | npm run backend","start:f":`cd ${t} && npm run next`,"start:b":`cd ${n} && npm run start`,start:"npm run start:b | npm run start:f"},await(0,common_1.savePackageJson)(e,s),await(0,fs_extra_1.writeFile)(path_1.default.join(e,".gitignore"),a.join("\n")),await(0,common_1.generateTemplate)(e,"dev-env/next-app"),await(0,common_1.replaceAppName)(path_1.default.join(e,".devcontainer/docker-compose.yml"),r),await(0,common_1.replaceAppName)(path_1.default.join(e,".devcontainer/devcontainer.json"),r),await(0,common_1.replaceTexts)(path_1.default.join(e,".vscode/settings.json"),[{anchor:"__adds__",text:["**/.next","**/.nexpress"].map((e=>`    "${e}": true`)).join(",\n")}]),await(0,fs_extra_1.copy)(path_1.default.join((0,common_1.getTemplateBaseDirname)(),"next-app/README.separate.md"),path_1.default.join(e,"README.md")),await(0,common_1.replaceTexts)(path_1.default.join(e,"README.md"),[{anchor:"__APP_TYPE__",text:"web application"},{anchor:"__frontendDir__",text:t},{anchor:"__backendDir__",text:n}]),void(0,common_1.removeGit)(e)}const E=path_1.default.join(e,a?.targetDir??"");(0,child_process_1.spawnSync)("npx",["create-next-app",E,"--ts","--use-npm"],{shell:!0,stdio:"inherit",cwd:e});const w=path_1.default.join(E,"next.config.js"),g=(await(0,fs_extra_1.readFile)(w)).toString().split(/\n|\r\n/g),P=g.findIndex((e=>e.match(/^}(;|\s)*$/)))??1;g[P-1].match(/,$/)||(g[P-1]=g[P-1]+",");let T=[],j=[],v=[];const S=path_1.default.join(E,".gitignore");let b=(await(0,fs_extra_1.readFile)(S)).toString();b=b.replace("/.next/","/.next/"),b+="\n# develop";const O=e=>{e.forEach((e=>{b+=`\n${e}`}))};O(["/.vscode/settings.json",".env","/dist/"]);const k=[m],R=async e=>{const t=path_1.default.join(E,e);(0,fs_extra_1.existsSync)(t)&&await(0,fs_extra_1.move)(t,path_1.default.join(E,i,e),{overwrite:!0})};await R("next-env.d.ts"),await R("pages"),await R("public"),rimraf_1.default.sync(path_1.default.join(E,"styles"));const D=await(0,common_1.getPackageJson)(E,{appName:r});D.name=r,D.version="0.0.0-alpha.0";const I=["@bizhermit/basic-utils"],N=["rimraf"];let $=!1,y=!1,B=!1;const H=["node_modules","/.*"],C=["[Next.js](https://nextjs.org/)"];let M="",F="";if("desktop"!==t&&"all"!==t||($=!0,H.push(_),await(0,common_1.generateTemplate)(E,"next-app/desktop"),I.push("fs-extra","electron-is-dev","electron-next"),N.push("@bizhermit/minifier","@types/fs-extra","electron","electron-builder")),"frontend"===t||"desktop"===t?(await(0,common_1.generateTemplate)(E,"next-app/backend"),rimraf_1.default.sync(path_1.default.join(E,p)),$&&await(0,common_1.generateTemplate)(E,"next-app/backend-desktop")):(y=!0,await(0,common_1.generateTemplate)(E,"next-app/backend"),$&&await(0,common_1.generateTemplate)(E,"next-app/backend-desktop"),I.push("dotenv","express","express-session","helmet","cors","csurf","cookie-parser","cookies-next"),N.push("@types/dotenv","@types/express","@types/express-session","@types/cors","@types/csurf","@types/cookie-parser")),"backend"!==t&&(B=!0,await(0,common_1.generateTemplate)(E,"next-app/frontend"),$&&await(0,common_1.generateTemplate)(E,"next-app/frontend-desktop"),I.push("@bizhermit/react-addon"),(a?.crossBasePath||"desktop"!==t)&&I.push("cookies-next")),await(0,common_1.generateTemplate)(E,"next-app/api"),"desktop"===t&&await(0,common_1.generateTemplate)(E,"next-app/desktop"),"backend"===t)D.scripts={build:"npx next build"};else{H.push(_);const e=a?.distFlat?_:"dist/next";D.scripts={dev:"npx next dev -p 3000",build:"npx next build",next:"npm run build && npx next start -p 80",export:`npx rimraf ${e} && npm run build && npx next export -o ${e}`}}if(B&&(F+=await A("README.next.md"),H.push(m),D.scripts={...D.scripts},(a?.crossBasePath||"frontend"!==t)&&await(0,common_1.replaceTexts)(path_1.default.join(E,"src/pages/_app.tsx"),[{anchor:"// ",text:""}])),y&&(await(0,common_1.replaceTexts)(path_1.default.join(E,p,"main.ts"),[{anchor:common_1.__appName__,text:r},{anchor:o,text:i}]),await(0,common_1.replaceTexts)(path_1.default.join(E,p,"tsconfig.json"),[{anchor:"__nexpressDistDir__",text:d}]),C.push("[Express](https://expressjs.com/)"),F+=await A("README.nexpress.md"),H.push(p),H.push(d),O(["/.nexpress/"]),k.push(".nexpress",{file:"nexpress",comment:!0}),D.scripts={...D.scripts,nexpress:"npx rimraf .next && npm run prestart && node .nexpress/main.js -d",prestart:"npx rimraf .nexpress && npx tsc -p nexpress/tsconfig.json",start:"npm run build && node .nexpress/main.js"}),$){await(0,common_1.replaceTexts)(path_1.default.join(E,c,"main.ts"),[{anchor:common_1.__appName__,text:r},{anchor:o,text:i},{anchor:l,text:x},{anchor:"__rendererDistDir__",text:u}]),await(0,common_1.replaceTexts)(path_1.default.join(E,c,"tsconfig.json"),[{anchor:o,text:i},{anchor:l,text:x}]),C.push("[Electron](https://www.electronjs.org/)"),F+=await A("README.nextron.md"),H.push(c),H.push(x),H.push(u),O(["/.main/","/.renderer/","/resources/config.json"]),k.push(".main",".renderer",{file:"nextron",comment:!0});const e=a?.distFlat?_:"dist/pack";D.scripts={...D.scripts,"clean:nextron":"npx rimraf .main .renderer",nextron:"npx rimraf .next && npm run predist && npx electron .main/nextron/main.js",predist:`npm run clean:nextron -- ${e} && npx tsc -p nextron/tsconfig.json`,dist:"npm run build && npx next export -o .renderer && npx minifier .main && npx minifier .renderer && npx electron-builder","dist:linux":"npm run dist -- --linux & npm run clean:nextron","dist:win":"npm run dist -- --win & npm run clean:nextron","dist:mac":"npm run dist -- --mac & npm run clean:nextron",pack:`npm run dist -- --dir --${s} & npm run clean:nextron`};const t="src/public/favicon.ico";D.build={appId:`example.${r}`,productName:r,asar:!0,extends:null,extraMetadata:{main:".main/nextron/main.js"},files:["!src","!nextron","!nexpress",".main/**/*",".renderer/**/*","src/public"],extraFiles:[{from:"resources",to:"resources",filter:["**/*","!config.json"]},{from:"LICENSE",to:"LICENSE"},{from:"CREDIT",to:"CREDIT"}],directories:{output:`${e}`},win:{icon:t,target:{target:"nsis",arch:["x64"]}},mac:{icon:t,target:"dmg"},linux:{icon:t,target:["deb","rpm","snap","AppImage"],category:"Development"},nsis:{oneClick:!1,allowToChangeInstallationDirectory:!0,installerIcon:t,installerHeaderIcon:t}},D.browser={fs:!1,path:!1}}switch(T=["  basePath: process.env.BASE_PATH,","  env: {","    BASE_PATH: process.env.BASE_PATH,","    PORT: process.env.PORT,","    API_BASE_PATH: process.env.BASE_PATH,","  }"],j=["BASE_PATH=","PORT=8000","",`SESSION_NAME=${r}`,`SESSION_SECRET=${r}`,`COOKIE_PARSER_SECRET=${r}`,"",`CORS_ORIGIN=http://localhost:${a?.corsOriginPort??h}`,"CSRF_PATH=/csrf"],v=["BASE_PATH=","PORT=80","",`SESSION_NAME=${r}`,`SESSION_SECRET=${r}`,`COOKIE_PARSER_SECRET=${r}`,"","CORS_ORIGIN=https://localhost:80","CSRF_PATH=/csrf"],t){case"desktop":M="desktop application",D.scripts={clean:"npx rimraf dist .main .renderer .next node_modules",...D.scripts};break;case"backend":M="backend application server",D.scripts={clean:"npx rimraf .nexpress .next node_modules",...D.scripts};break;case"frontend":M="frontend application server",D.scripts={clean:"npx rimraf dist .nexpress .next node_modules",...D.scripts},T=["  basePath: process.env.BASE_PATH,","  env: {","    BASE_PATH: process.env.BASE_PATH,","    API_PROTOCOL: process.env.API_PROTOCOL,","    API_HOST_NAME: process.env.API_HOST_NAME,","    API_PORT: process.env.API_PORT,","    API_BASE_PATH: process.env.API_BASE_PATH,","  }"],j=["BASE_PATH=","API_PROTOCOL=http:","API_HOST_NAME=localhost",`API_PORT=${a?.corsOriginPort?h:f}`,"API_BASE_PATH="],v=["BASE_PATH=","API_PROTOCOL=https:","API_HOST_NAME=localhost","API_PORT=80","API_BASE_PATH="];break;case"web":M="web application server",D.scripts={clean:"npx rimraf dist .nexpress .next node_modules",...D.scripts};break;default:M="web & desktop application",D.scripts={clean:"npx rimraf dist .nexpress .main .renderer .next node_modules",...D.scripts}}await(0,common_1.savePackageJson)(E,D),(0,common_1.installLibs)(E,I,N),await(0,common_1.replaceTexts)(path_1.default.join(E,"tsconfig.json"),[{anchor:'"node_modules"',text:[...new Set(H)].filter((e=>string_utils_1.default.isNotEmpty(e)&&!e.startsWith("."))).map((e=>`"${e}"`)).join(", ")}]),T.filter((e=>string_utils_1.default.isNotEmpty(e))).forEach(((e,t)=>{g.splice(P+t,0,e)})),await(0,fs_extra_1.writeFile)(w,g.join("\n")),await(0,fs_extra_1.writeFile)(path_1.default.join(E,".env"),j.join("\n")),await(0,fs_extra_1.writeFile)(path_1.default.join(E,"..env"),v.join("\n")),await(0,fs_extra_1.writeFile)(S,b),await(0,fs_extra_1.copy)(path_1.default.join((0,common_1.getTemplateBaseDirname)(),"next-app/README.md"),path_1.default.join(E,"README.md")),await(0,common_1.replaceTexts)(path_1.default.join(E,"README.md"),[{anchor:"__APP_TYPE__",text:M},{anchor:"__POWERED_BY__",text:C.join(", ")},{anchor:"__ADDON_README__",text:F}]),await(0,common_1.generateTemplate)(e,"dev-env/next-app"),await(0,common_1.replaceAppName)(path_1.default.join(e,".devcontainer/docker-compose.yml"),r),await(0,common_1.replaceAppName)(path_1.default.join(e,".devcontainer/devcontainer.json"),r),await(0,common_1.replaceTexts)(path_1.default.join(e,".vscode/settings.json"),[{anchor:"__adds__",text:k.map((e=>"string"==typeof e?`    "${e}": true`:`    ${e.comment?"// ":""}"${e.file}": ${String(e.flag??!0)}`)).join(",\n")}]),(0,common_1.removeGit)(E)};exports.default=createNextApp;