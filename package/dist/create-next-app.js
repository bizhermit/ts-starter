"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const string_utils_1=__importDefault(require("@bizhermit/basic-utils/dist/string-utils")),child_process_1=require("child_process"),fs_extra_1=require("fs-extra"),path_1=__importDefault(require("path")),rimraf_1=__importDefault(require("rimraf")),common_1=require("./common"),createNextApp=async(e,t="all",n=!1,a)=>{const{appName:r,platform:s}=(0,common_1.analyzeArgsOptions)(e,a),o="__srcDir__",i="src",p="nexpress",c="nextron",_="dist",m=".next",d=".nexpress",l="__mainDistDir__",x=".main",u=".renderer",f=8e3,h=async e=>(await(0,fs_extra_1.readFile)(path_1.default.join((0,common_1.getTemplateBaseDirname)(),"next-app",e))).toString();if("web"===t&&n){const t="frontend",n="backend";await createNextApp(e,t,!1,{appName:`${r}-frontend`,targetDir:t,crossBasePath:`${r}-backend`,distFlat:!0}),await createNextApp(e,n,!1,{appName:`${r}-backend`,targetDir:n,corsOriginPort:3e3});const a=(await(0,fs_extra_1.readFile)(path_1.default.join(e,t,".gitignore"))).toString().split(/\n/g);a.splice(a.indexOf("# develop")-a.length+1),a.push(".vscode/settings.json",`/${t}/dist/`,".next",".nexpress");const s=await(0,common_1.getPackageJson)(e,{appName:r});return s.scripts={frontend:`cd ${t} && npm run dev`,backend:`cd ${n} && npm run nexpress`,dev:"npm run frontend | npm run backend","start:f":`cd ${t} && npm run next`,"start:b":`cd ${n} && npm run start`,start:"npm run start:b | npm run start:f"},await(0,common_1.savePackageJson)(e,s),await(0,fs_extra_1.writeFile)(path_1.default.join(e,".gitignore"),a.join("\n")),await(0,common_1.generateTemplate)(e,"dev-env/next-app"),await(0,common_1.replaceAppName)(path_1.default.join(e,".devcontainer/docker-compose.yml"),r),await(0,common_1.replaceAppName)(path_1.default.join(e,".devcontainer/devcontainer.json"),r),await(0,common_1.replaceTexts)(path_1.default.join(e,".vscode/settings.json"),[{anchor:"__adds__",text:["**/.next","**/.nexpress"].map((e=>`    "${e}": true`)).join(",\n")}]),await(0,fs_extra_1.copy)(path_1.default.join((0,common_1.getTemplateBaseDirname)(),"next-app/README.separate.md"),path_1.default.join(e,"README.md")),await(0,common_1.replaceTexts)(path_1.default.join(e,"README.md"),[{anchor:"__APP_TYPE__",text:"web application"},{anchor:"__frontendDir__",text:t},{anchor:"__backendDir__",text:n}]),void(0,common_1.removeGit)(e)}const A=path_1.default.join(e,a?.targetDir??"");(0,child_process_1.spawnSync)("npx",["create-next-app",A,"--ts","--use-npm"],{shell:!0,stdio:"inherit",cwd:e});const E=path_1.default.join(A,"next.config.js"),w=(await(0,fs_extra_1.readFile)(E)).toString().split(/\n|\r\n/g),P=w.findIndex((e=>e.match(/^}(;|\s)*$/)))??1;w[P-1].match(/,$/)||(w[P-1]=w[P-1]+",");let g=[],T=[],j=[];const v=path_1.default.join(A,".gitignore");let b=(await(0,fs_extra_1.readFile)(v)).toString();b=b.replace("/.next/","/.next/"),b+="\n# develop";const S=e=>{e.forEach((e=>{b+=`\n${e}`}))};S(["/.vscode/settings.json","/dist/"]);const O=[m],k=async e=>{const t=path_1.default.join(A,e);(0,fs_extra_1.existsSync)(t)&&await(0,fs_extra_1.move)(t,path_1.default.join(A,i,e),{overwrite:!0})};await k("next-env.d.ts"),await k("pages"),await k("public"),rimraf_1.default.sync(path_1.default.join(A,"styles"));const R=await(0,common_1.getPackageJson)(A,{appName:r});R.name=r,R.version="0.0.0-alpha.0";const D=["@bizhermit/basic-utils"],I=["rimraf"];let N=!1,$=!1,y=!1;const H=["node_modules","/.*"],B=["[Next.js](https://nextjs.org/)"];let C="",M="";if("desktop"!==t&&"all"!==t||(N=!0,H.push(_),await(0,common_1.generateTemplate)(A,"next-app/desktop"),await(0,common_1.replaceTexts)(path_1.default.join(A,c,"main.ts"),[{anchor:common_1.__appName__,text:r},{anchor:o,text:i},{anchor:l,text:x},{anchor:"__rendererDistDir__",text:u}]),await(0,common_1.replaceTexts)(path_1.default.join(A,c,"tsconfig.json"),[{anchor:o,text:i},{anchor:l,text:x}]),D.push("fs-extra","electron-is-dev","electron-next"),I.push("@bizhermit/minifier","@types/fs-extra","electron","electron-builder")),"frontend"===t||"desktop"===t?(await(0,common_1.generateTemplate)(A,"next-app/backend"),rimraf_1.default.sync(path_1.default.join(A,p)),N&&await(0,common_1.generateTemplate)(A,"next-app/backend-desktop")):($=!0,await(0,common_1.generateTemplate)(A,"next-app/backend"),N&&await(0,common_1.generateTemplate)(A,"next-app/backend-desktop"),await(0,common_1.replaceTexts)(path_1.default.join(A,p,"main.ts"),[{anchor:common_1.__appName__,text:r},{anchor:o,text:i}]),await(0,common_1.replaceTexts)(path_1.default.join(A,p,"tsconfig.json"),[{anchor:"__nexpressDistDir__",text:d}]),D.push("dotenv","express","express-session","helmet","cors","csurf","cookie-parser","cookies-next"),I.push("@types/dotenv","@types/express","@types/express-session","@types/cors","@types/csurf","@types/cookie-parser")),"backend"!==t&&(y=!0,await(0,common_1.generateTemplate)(A,"next-app/frontend"),N&&await(0,common_1.generateTemplate)(A,"next-app/frontend-desktop"),D.push("@bizhermit/react-addon"),a?.crossBasePath&&D.push("cookies-next")),await(0,common_1.generateTemplate)(A,"next-app/api"),"backend"===t)R.scripts={build:"npx next build"};else{H.push(_);const e=a?.distFlat?_:"dist/next";R.scripts={dev:"npx next dev -p 3000",build:"npx next build",next:"npm run build && npx next start -p 80",export:`npx rimraf ${e} && npm run build && npx next export -o ${e}`}}if(y&&(M+=await h("README.next.md"),H.push(m),R.scripts={...R.scripts}),$&&(B.push("[Express](https://expressjs.com/)"),M+=await h("README.nexpress.md"),H.push(p),H.push(d),S(["/.nexpress/"]),O.push(".nexpress"),R.scripts={...R.scripts,nexpress:"npx rimraf .next && npm run prestart && node .nexpress/main.js -d",prestart:"npx rimraf .nexpress && npx tsc -p nexpress/tsconfig.json",start:"npm run build && node .nexpress/main.js"}),N){B.push("[Electron](https://www.electronjs.org/)"),M+=await h("README.nextron.md"),H.push(c),H.push(x),H.push(u),S(["/.main/","/.renderer/","/resources/config.json"]),O.push(".main",".renderer");const e=a?.distFlat?_:"dist/pack";R.scripts={...R.scripts,"clean:nextron":"npx rimraf .main .renderer",nextron:"npx rimraf .next && npm run predist && npx electron .main/nextron/main.js",predist:`npm run clean:nextron -- ${e} && npx tsc -p nextron/tsconfig.json`,dist:"npm run build && npx next export -o .renderer && npx minifier .main && npx minifier .renderer && npx electron-builder","dist:linux":"npm run dist -- --linux & npm run clean:nextron","dist:win":"npm run dist -- --win & npm run clean:nextron","dist:mac":"npm run dist -- --mac & npm run clean:nextron",pack:`npm run dist -- --dir --${s} & npm run clean:nextron`};const t="src/public/favicon.ico";R.build={appId:`example.${r}`,productName:r,asar:!0,extends:null,extraMetadata:{main:".main/nextron/main.js"},files:["!src","!nextron","!nexpress",".main/**/*",".renderer/**/*","src/public"],extraFiles:[{from:"resources",to:"resources",filter:["**/*","!config.json"]},{from:"LICENSE",to:"LICENSE"},{from:"CREDIT",to:"CREDIT"}],directories:{output:`${e}`},win:{icon:t,target:{target:"nsis",arch:["x64"]}},mac:{icon:t,target:"dmg"},linux:{icon:t,target:["deb","rpm","snap","AppImage"],category:"Development"},nsis:{oneClick:!1,allowToChangeInstallationDirectory:!0,installerIcon:t,installerHeaderIcon:t}},R.browser={fs:!1,path:!1}}switch(g=["  basePath: process.env.BASE_PATH,","  env: {","    BASE_PATH: process.env.BASE_PATH,","    PORT: process.env.PORT,","    API_BASE_PATH: process.env.BASE_PATH,","  }"],T=["BASE_PATH=","PORT=8000","",`SESSION_NAME=${r}`,`SESSION_SECRET=${r}`,`COOKIE_PARSER_SECRET=${r}`,"",`CORS_ORIGIN=http://localhost:${a?.corsOriginPort??f}`,"CSRF_PATH=/csrf"],j=["BASE_PATH=","PORT=80","",`SESSION_NAME=${r}`,`SESSION_SECRET=${r}`,`COOKIE_PARSER_SECRET=${r}`,"","CORS_ORIGIN=https://localhost:80","CSRF_PATH=/csrf"],t){case"desktop":C="desktop application",R.scripts={clean:"npx rimraf dist .main .renderer .next node_modules",...R.scripts};break;case"backend":C="backend application server",R.scripts={clean:"npx rimraf .nexpress .next node_modules",...R.scripts};break;case"frontend":C="frontend application server",R.scripts={clean:"npx rimraf dist .nexpress .next node_modules",...R.scripts},g=["  basePath: process.env.BASE_PATH,","  env: {","    BASE_PATH: process.env.BASE_PATH,","    API_PROTOCOL: process.env.API_PROTOCOL,","    API_HOST_NAME: process.env.API_HOST_NAME,","    API_PORT: process.env.API_PORT,","    API_BASE_PATH: process.env.API_BASE_PATH,","  }"],T=["BASE_PATH=","API_PROTOCOL=http:","API_HOST_NAME=localhost","API_PORT=8000","API_BASE_PATH="],j=["BASE_PATH=","API_PROTOCOL=https:","API_HOST_NAME=localhost","API_PORT=80","API_BASE_PATH="];break;case"web":C="web application server",R.scripts={clean:"npx rimraf dist .nexpress .next node_modules",...R.scripts};break;default:C="web & desktop application",R.scripts={clean:"npx rimraf dist .nexpress .main .renderer .next node_modules",...R.scripts}}await(0,common_1.savePackageJson)(A,R),(0,common_1.installLibs)(A,D,I),await(0,common_1.replaceTexts)(path_1.default.join(A,"tsconfig.json"),[{anchor:'"node_modules"',text:[...new Set(H)].filter((e=>string_utils_1.default.isNotEmpty(e)&&!e.startsWith("."))).map((e=>`"${e}"`)).join(", ")}]),g.filter((e=>string_utils_1.default.isNotEmpty(e))).forEach(((e,t)=>{w.splice(P+t,0,e)})),await(0,fs_extra_1.writeFile)(E,w.join("\n")),await(0,fs_extra_1.writeFile)(path_1.default.join(A,".env"),T.join("\n")),await(0,fs_extra_1.writeFile)(path_1.default.join(A,"..env"),j.join("\n")),await(0,fs_extra_1.writeFile)(v,b),await(0,fs_extra_1.copy)(path_1.default.join((0,common_1.getTemplateBaseDirname)(),"next-app/README.md"),path_1.default.join(A,"README.md")),await(0,common_1.replaceTexts)(path_1.default.join(A,"README.md"),[{anchor:"__APP_TYPE__",text:C},{anchor:"__POWERED_BY__",text:B.join(", ")},{anchor:"__ADDON_README__",text:M}]),await(0,common_1.generateTemplate)(e,"dev-env/next-app"),await(0,common_1.replaceAppName)(path_1.default.join(e,".devcontainer/docker-compose.yml"),r),await(0,common_1.replaceAppName)(path_1.default.join(e,".devcontainer/devcontainer.json"),r),await(0,common_1.replaceTexts)(path_1.default.join(e,".vscode/settings.json"),[{anchor:"__adds__",text:O.map((e=>`    "${e}": true`)).join(",\n")}]),(0,common_1.removeGit)(A)};exports.default=createNextApp;